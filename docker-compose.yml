version: '3.8'

services:
  # Auth Service Database
  auth-db:
    image: postgres:15
    container_name: auth-db
    environment:
      POSTGRES_USER: ${AUTH_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD:-postgres}
      POSTGRES_DB: ${AUTH_DB_NAME:-postgres}
    ports:
      - "5432:5432"
    volumes:
      - auth_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network

  # Auth Service
  auth-service:
    build:
      context: .
      dockerfile: ./auth-service/Dockerfile
    container_name: auth-service
    depends_on:
      auth-db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://${AUTH_DB_USER:-postgres}:${AUTH_DB_PASSWORD:-postgres}@auth-db:5432/${AUTH_DB_NAME:-postgres}?sslmode=${DB_SSLMODE:-disable}
      PORT: "${AUTH_SERVICE_PORT:-8080}"
      GRPC_PORT: "${AUTH_GRPC_PORT:-9090}"
      ACCESS_SECRET: "${ACCESS_SECRET:-super-secret-access}"
      REFRESH_SECRET: "${REFRESH_SECRET:-super-secret-refresh}"
      ACCESS_MINUTES: "${ACCESS_MINUTES:-15}"
      REFRESH_HOURS: "${REFRESH_HOURS:-168}"
      LOG_LEVEL: "${LOG_LEVEL:-info}"
    ports:
      - "${AUTH_SERVICE_PORT:-8080}:${AUTH_SERVICE_PORT:-8080}"
      - "${AUTH_GRPC_PORT:-9090}:${AUTH_GRPC_PORT:-9090}"
    restart: on-failure
    networks:
      - microservices-network

  # Redis Cache for Chat Service
  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - microservices-network

  # Chat Service Database
  chat-db:
    image: postgres:15-alpine
    container_name: chat-db
    environment:
      POSTGRES_USER: ${CHAT_DB_USER:-chat_user}
      POSTGRES_PASSWORD: ${CHAT_DB_PASSWORD:-chat_pass}
      POSTGRES_DB: ${CHAT_DB_NAME:-chat_db}
    ports:
      - "${CHAT_DB_PORT:-5434}:5432"
    volumes:
      - chat_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${CHAT_DB_USER:-chat_user} -d ${CHAT_DB_NAME:-chat_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network

  # Chat Service
  chat-service:
    build:
      context: .
      dockerfile: ./chat-service/Dockerfile
    container_name: chat-service
    ports:
      - "${CHAT_SERVICE_PORT:-8082}:${CHAT_SERVICE_PORT:-8082}"
      - "${CHAT_GRPC_PORT:-9092}:${CHAT_GRPC_PORT:-9092}"
    environment:
      DATABASE_URL: postgres://${CHAT_DB_USER:-chat_user}:${CHAT_DB_PASSWORD:-chat_pass}@chat-db:5432/${CHAT_DB_NAME:-chat_db}?sslmode=${DB_SSLMODE:-disable}
      PORT: "${CHAT_SERVICE_PORT:-8082}"
      GRPC_PORT: "${CHAT_GRPC_PORT:-9092}"
      MAXBOT_GRPC_ADDR: ${MAXBOT_GRPC_ADDR:-maxbot-service:9095}
      MAXBOT_TIMEOUT: ${MAXBOT_TIMEOUT:-5s}
      AUTH_GRPC_ADDR: ${AUTH_GRPC_ADDR:-auth-service:9090}
      AUTH_TIMEOUT: ${AUTH_TIMEOUT:-5s}
      LOG_LEVEL: "${LOG_LEVEL:-info}"
      # Redis Configuration for Participants Background Sync
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      REDIS_MAX_RETRIES: ${REDIS_MAX_RETRIES:-5}
      REDIS_RETRY_DELAY: ${REDIS_RETRY_DELAY:-1s}
      REDIS_HEALTH_CHECK_INTERVAL: ${REDIS_HEALTH_CHECK_INTERVAL:-30s}
      PARTICIPANTS_CACHE_TTL: ${PARTICIPANTS_CACHE_TTL:-1h}
      PARTICIPANTS_UPDATE_INTERVAL: ${PARTICIPANTS_UPDATE_INTERVAL:-15m}
      PARTICIPANTS_FULL_UPDATE_HOUR: ${PARTICIPANTS_FULL_UPDATE_HOUR:-3}
      PARTICIPANTS_BATCH_SIZE: ${PARTICIPANTS_BATCH_SIZE:-50}
      PARTICIPANTS_MAX_API_TIMEOUT: ${PARTICIPANTS_MAX_API_TIMEOUT:-30s}
      PARTICIPANTS_STALE_THRESHOLD: ${PARTICIPANTS_STALE_THRESHOLD:-1h}
      PARTICIPANTS_ENABLE_BACKGROUND_SYNC: ${PARTICIPANTS_ENABLE_BACKGROUND_SYNC:-true}
      PARTICIPANTS_ENABLE_LAZY_UPDATE: ${PARTICIPANTS_ENABLE_LAZY_UPDATE:-true}
      PARTICIPANTS_INTEGRATION_DISABLED: ${PARTICIPANTS_INTEGRATION_DISABLED:-false}
    depends_on:
      chat-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      auth-service:
        condition: service_started
      maxbot-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - microservices-network

  # Employee Service Database
  employee-db:
    image: postgres:15-alpine
    container_name: employee-db
    environment:
      POSTGRES_USER: ${EMPLOYEE_DB_USER:-employee_user}
      POSTGRES_PASSWORD: ${EMPLOYEE_DB_PASSWORD:-employee_pass}
      POSTGRES_DB: ${EMPLOYEE_DB_NAME:-employee_db}
    ports:
      - "${EMPLOYEE_DB_PORT:-5433}:5432"
    volumes:
      - employee_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${EMPLOYEE_DB_USER:-employee_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network

  # Employee Service
  employee-service:
    build:
      context: .
      dockerfile: ./employee-service/Dockerfile
    container_name: employee-service
    ports:
      - "${EMPLOYEE_SERVICE_PORT:-8081}:${EMPLOYEE_SERVICE_PORT:-8081}"
      - "${EMPLOYEE_GRPC_PORT:-9091}:${EMPLOYEE_GRPC_PORT:-9091}"
    environment:
      DATABASE_URL: postgres://${EMPLOYEE_DB_USER:-employee_user}:${EMPLOYEE_DB_PASSWORD:-employee_pass}@employee-db:5432/${EMPLOYEE_DB_NAME:-employee_db}?sslmode=${DB_SSLMODE:-disable}
      PORT: "${EMPLOYEE_SERVICE_PORT:-8081}"
      GRPC_PORT: "${EMPLOYEE_GRPC_PORT:-9091}"
      MAXBOT_GRPC_ADDR: ${MAXBOT_GRPC_ADDR:-maxbot-service:9095}
      MAXBOT_TIMEOUT: ${MAXBOT_TIMEOUT:-5s}
      AUTH_GRPC_ADDR: ${AUTH_GRPC_ADDR:-auth-service:9090}
      LOG_LEVEL: "${LOG_LEVEL:-info}"
      # Profile Cache Integration
      PROFILE_CACHE_ENABLED: ${PROFILE_CACHE_ENABLED:-true}
      PROFILE_CACHE_TIMEOUT: ${PROFILE_CACHE_TIMEOUT:-3s}
    depends_on:
      employee-db:
        condition: service_healthy
      auth-service:
        condition: service_started
      maxbot-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - microservices-network

  # Structure Service Database
  structure-db:
    image: postgres:15
    container_name: structure-db
    environment:
      POSTGRES_USER: ${STRUCTURE_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${STRUCTURE_DB_PASSWORD:-postgres}
      POSTGRES_DB: ${STRUCTURE_DB_NAME:-structure_db}
    ports:
      - "${STRUCTURE_DB_PORT:-5435}:5432"
    volumes:
      - structure_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network

  # Structure Service
  structure-service:
    build:
      context: .
      dockerfile: ./structure-service/Dockerfile
    container_name: structure-service
    depends_on:
      structure-db:
        condition: service_healthy
      chat-service:
        condition: service_started
      employee-service:
        condition: service_started
    environment:
      DATABASE_URL: postgres://${STRUCTURE_DB_USER:-postgres}:${STRUCTURE_DB_PASSWORD:-postgres}@structure-db:5432/${STRUCTURE_DB_NAME:-structure_db}?sslmode=${DB_SSLMODE:-disable}
      PORT: "${STRUCTURE_SERVICE_PORT:-8083}"
      GRPC_PORT: "${STRUCTURE_GRPC_PORT:-9093}"
      CHAT_SERVICE_GRPC: ${CHAT_GRPC_ADDR:-chat-service:9092}
      EMPLOYEE_SERVICE_GRPC: ${EMPLOYEE_GRPC_ADDR:-employee-service:9091}
      LOG_LEVEL: "${LOG_LEVEL:-info}"
    ports:
      - "${STRUCTURE_SERVICE_PORT:-8083}:${STRUCTURE_SERVICE_PORT:-8083}"
      - "${STRUCTURE_GRPC_PORT:-9093}:${STRUCTURE_GRPC_PORT:-9093}"
    restart: on-failure
    networks:
      - microservices-network

  maxbot-service:
    build:
      context: .
      dockerfile: ./maxbot-service/Dockerfile
    container_name: maxbot-service
    environment:
      GRPC_PORT: "${MAXBOT_GRPC_PORT:-9095}"
      HTTP_PORT: "${MAXBOT_HTTP_PORT:-8095}"
      MAX_API_URL: ""
      MAX_API_TOKEN: "${MAX_API_TOKEN:-test-token-for-development}"
      MAX_API_TIMEOUT: ${MAX_API_TIMEOUT:-5s}
      MOCK_MODE: "${MOCK_MODE:-true}"
      LOG_LEVEL: "${LOG_LEVEL:-info}"
      # Redis Configuration for Profile Cache
      REDIS_ADDR: ${REDIS_ADDR:-redis:6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-1}
      PROFILE_TTL: ${PROFILE_TTL:-720h}
      # Webhook Configuration
      WEBHOOK_SECRET: ${WEBHOOK_SECRET:-}
      # Monitoring Configuration
      MONITORING_ENABLED: ${MONITORING_ENABLED:-true}
      PROFILE_QUALITY_ALERT_THRESHOLD: ${PROFILE_QUALITY_ALERT_THRESHOLD:-0.8}
      WEBHOOK_ERROR_ALERT_THRESHOLD: ${WEBHOOK_ERROR_ALERT_THRESHOLD:-0.05}
    ports:
      - "${MAXBOT_GRPC_PORT:-9095}:${MAXBOT_GRPC_PORT:-9095}"
      - "${MAXBOT_HTTP_PORT:-8095}:${MAXBOT_HTTP_PORT:-8095}"
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - microservices-network

  # Migration Service Database
  migration-db:
    image: postgres:15-alpine
    container_name: migration-db
    environment:
      POSTGRES_USER: ${MIGRATION_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${MIGRATION_DB_PASSWORD:-postgres}
      POSTGRES_DB: ${MIGRATION_DB_NAME:-migration_db}
    ports:
      - "${MIGRATION_DB_PORT:-5436}:5432"
    volumes:
      - migration_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microservices-network

  # Migration Service
  migration-service:
    build:
      context: .
      dockerfile: ./migration-service/Dockerfile
    container_name: migration-service
    environment:
      SERVER_PORT: "${MIGRATION_SERVICE_PORT:-8084}"
      DB_HOST: migration-db
      DB_PORT: "5432"
      DB_USER: ${MIGRATION_DB_USER:-postgres}
      DB_PASSWORD: ${MIGRATION_DB_PASSWORD:-postgres}
      DB_NAME: ${MIGRATION_DB_NAME:-migration_db}
      DB_SSLMODE: ${DB_SSLMODE:-disable}
      CHAT_SERVICE_URL: ${CHAT_SERVICE_URL:-http://chat-service:8082}
      STRUCTURE_SERVICE_URL: ${STRUCTURE_SERVICE_URL:-http://structure-service:8083}
      GOOGLE_CREDENTIALS_PATH: ${GOOGLE_CREDENTIALS_PATH:-/app/credentials/google-credentials.json}
      GOOGLE_SPREADSHEET_ID: "${GOOGLE_SPREADSHEET_ID:-}"
      LOG_LEVEL: "${LOG_LEVEL:-info}"
    ports:
      - "${MIGRATION_SERVICE_PORT:-8084}:${MIGRATION_SERVICE_PORT:-8084}"
    depends_on:
      migration-db:
        condition: service_healthy
      chat-service:
        condition: service_started
      structure-service:
        condition: service_started
    volumes:
      - ./migration-service/credentials:/app/credentials
      - ./migration-service/uploads:/tmp/migration-uploads
    mem_limit: 512m          # Увеличен лимит для обработки больших Excel файлов
    mem_reservation: 256m
    restart: unless-stopped
    networks:
      - microservices-network

volumes:
  auth_pgdata:
  chat_db_data:
  employee_db_data:
  structure_pgdata:
  migration_db_data:
  redis_data:

networks:
  microservices-network:
    driver: bridge

