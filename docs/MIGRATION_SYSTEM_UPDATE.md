# Обновление системы миграций

## Изменения

Система миграций была переработана для запуска и проверки миграций при старте каждого сервиса, а не в Docker Compose.

### Что изменилось

1. **Миграции теперь встроены в сервисы**
   - Каждый сервис самостоятельно запускает свои миграции при старте
   - Миграции встроены в бинарный файл через `embed.FS`
   - Автоматическое ожидание готовности базы данных

2. **Убраны volumes с migrations-init из docker-compose.yml**
   - Больше не нужны отдельные init-скрипты в Docker
   - Упрощена конфигурация Docker Compose
   - Миграции запускаются надежнее и быстрее

3. **Добавлена библиотека golang-migrate**
   - Профессиональная система управления миграциями
   - Поддержка rollback и версионирования
   - Защита от "грязных" состояний базы данных

## Структура файлов

Для каждого сервиса создана следующая структура:

```
<service>/
├── internal/infrastructure/migration/
│   ├── migrator.go              # Логика миграций
│   └── migrations/              # SQL файлы миграций
│       ├── 000001_init.up.sql
│       ├── 000001_init.down.sql
│       └── ...
```

## Функциональность

### Migrator

Каждый сервис имеет свой `Migrator` с функциями:

- `WaitForDatabase()` - ожидание готовности БД (до 30 попыток)
- `RunMigrations()` - выполнение всех миграций
- `CheckMigrations()` - проверка состояния без выполнения

### Автоматический запуск

При старте каждого сервиса:

1. Подключение к базе данных
2. Ожидание готовности БД
3. Автоматический запуск миграций
4. Логирование процесса
5. Продолжение запуска сервиса

## Преимущества

### Надежность
- Миграции всегда выполняются перед запуском сервиса
- Защита от запуска с неактуальной схемой БД
- Автоматическое восстановление из "грязных" состояний

### Простота развертывания
- Не нужно отдельно управлять миграциями
- Работает в любой среде (Docker, Kubernetes, локально)
- Самодостаточные сервисы

### Производительность
- Быстрый старт сервисов
- Параллельное выполнение миграций разных сервисов
- Нет зависимости от init-контейнеров

## Логирование

Каждый сервис логирует процесс миграций:

```
[MIGRATION] Starting database migrations...
[MIGRATION] Waiting for database connection...
[MIGRATION] Database connection established
[MIGRATION] Successfully migrated database from version 5 to 6
```

## Обратная совместимость

- Существующие миграции скопированы в новую структуру
- Версионирование сохранено
- Данные в БД не затрагиваются

## Команды для разработки

### Локальный запуск сервиса
```bash
cd auth-service
go run cmd/auth/main.go
```

### Проверка миграций
```bash
make deploy        # Полное развертывание с миграциями
make up           # Запуск сервисов (миграции выполнятся автоматически)
make logs-auth    # Просмотр логов миграций auth-service
```

### Отладка миграций
```bash
# Просмотр логов всех сервисов
make logs

# Проверка состояния БД
make check-volumes

# Перезапуск с новыми миграциями
make restart
```

## Устранение неполадок

### Сервис не запускается
1. Проверьте логи: `make logs-<service>`
2. Убедитесь, что БД доступна
3. Проверьте синтаксис SQL в миграциях

### "Грязное" состояние БД
Система автоматически пытается исправить, но если не получается:
```bash
# Пересоздать БД (ВНИМАНИЕ: удалит данные)
make clean-volumes-dangerous
make deploy
```

### Откат миграций
Используйте down-миграции или восстановите из бэкапа:
```bash
make backup-auth    # Создать бэкап
make restore-auth   # Восстановить из бэкапа
```

## Добавление новых миграций

1. Создайте файлы в `<service>/internal/infrastructure/migration/migrations/`:
   ```
   000007_add_new_table.up.sql
   000007_add_new_table.down.sql
   ```

2. Перезапустите сервис:
   ```bash
   make restart
   ```

3. Миграция выполнится автоматически при старте

## Мониторинг

Следите за логами миграций в production:
- Время выполнения
- Ошибки миграций
- Версии схемы БД

Система обеспечивает надежное и автоматическое управление схемой базы данных для всех микросервисов.