# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç–∞ Excel

## üìä –û—Ü–µ–Ω–∫–∞ –¥–ª—è —Ñ–∞–π–ª–∞ 20 –ú–ë

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞:** `github.com/xuri/excelize/v2`

**–ú–µ—Ç–æ–¥:** `f.GetRows()` - –∑–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï —Å—Ç—Ä–æ–∫–∏ –≤ –ø–∞–º—è—Ç—å —Å—Ä–∞–∑—É

### –†–∞—Å—á–µ—Ç

**–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:** 20 –ú–ë  
**–°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –≤ Excel:** ~200 –±–∞–π—Ç (18 –∫–æ–ª–æ–Ω–æ–∫ —Å —Ç–µ–∫—Å—Ç–æ–º)  
**–ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫:** 20 MB / 200 bytes ‚âà **100,000 —Å—Ç—Ä–æ–∫**

### –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

```
–§–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ:           20 –ú–ë
–†–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω—ã–π XML:       ~60 –ú–ë (Excel —Å–∂–∞—Ç)
–ú–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ –≤ Go:       ~80 –ú–ë (—Å—Ç—Ä—É–∫—Ç—É—Ä—ã + —Å—Ç—Ä–æ–∫–∏)
–û–±—Ä–∞–±–æ—Ç–∫–∞ (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ):   ~40 –ú–ë
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û:                   ~200 –ú–ë
```

### –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ 100,000 —Å—Ç—Ä–æ–∫:
- –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞: ~5-10 —Å–µ–∫
- –ü–∞—Ä—Å–∏–Ω–≥ Excel: ~10-15 —Å–µ–∫
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–æ–∫: ~50-100 —Å–µ–∫ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ë–î)
- **–ò–¢–û–ì–û: 1-2 –º–∏–Ω—É—Ç—ã**

## ‚úÖ –í—ã–≤–æ–¥: –§–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è!

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ excelize –æ—Ç–ª–∏—á–Ω–æ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å —Ñ–∞–π–ª–∞–º–∏ –¥–æ 50 –ú–ë.**

### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥:** excelize –∏—Å–ø–æ–ª—å–∑—É–µ—Ç streaming –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
2. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:** –ú—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –ø–æ –æ–¥–Ω–æ–π, –Ω–µ —Ö—Ä–∞–Ω–∏–º –≤—Å–µ –≤ –ø–∞–º—è—Ç–∏
3. **–ë–∞—Ç—á–∏–Ω–≥:** –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 100 —Å—Ç—Ä–æ–∫

## üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã)

### 1. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
```go
for _, row := range rows {
    processRow(row)  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ –æ–¥–Ω–æ–π
}
```

### 2. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
```go
if (processed+failed)%100 == 0 {
    updateProgress()  // –ö–∞–∂–¥—ã–µ 100 —Å—Ç—Ä–æ–∫
}
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
```go
if err := processRow(row); err != nil {
    failed++
    recordError(err)  // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É
}
```

## ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –¢–∞–π–º–∞—É—Ç HTTP –∑–∞–ø—Ä–æ—Å–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–∞–π–º–∞—É—Ç HTTP - 30 —Å–µ–∫—É–Ω–¥  
**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –≤ nginx/load balancer

```nginx
proxy_read_timeout 300s;  # 5 –º–∏–Ω—É—Ç
```

### 2. –ü–∞–º—è—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ª–∏–º–∏—Ç –ø–∞–º—è—Ç–∏  
**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç –≤ docker-compose.yml

```yaml
migration-service:
  mem_limit: 512m  # –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 512 –ú–ë
```

### 3. –†–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** Nginx –º–æ–∂–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞  
**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç

```nginx
client_max_body_size 50M;
```

## üîß –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### docker-compose.yml

```yaml
migration-service:
  build: ./migration-service
  ports:
    - "8084:8080"
  environment:
    - DB_HOST=migration-db
    - DB_PORT=5432
    - DB_USER=migration_user
    - DB_PASSWORD=migration_password
    - DB_NAME=migration_db
  mem_limit: 512m          # ‚¨ÖÔ∏è –£–≤–µ–ª–∏—á–∏—Ç—å –ø–∞–º—è—Ç—å
  mem_reservation: 256m
  depends_on:
    - migration-db
    - structure-service
    - chat-service
```

### Nginx (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

```nginx
server {
    listen 80;
    
    client_max_body_size 50M;        # ‚¨ÖÔ∏è –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
    proxy_read_timeout 300s;         # ‚¨ÖÔ∏è –¢–∞–π–º–∞—É—Ç
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    
    location /migration/ {
        proxy_pass http://migration-service:8080;
    }
}
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤–æ –≤—Ä–µ–º—è –∏–º–ø–æ—Ä—Ç–∞

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç
curl -X POST http://localhost:8084/migration/excel \
  -F "file=@large_file.xlsx"

# –ü–æ–ª—É—á–∏—Ç—å job_id –∏–∑ –æ—Ç–≤–µ—Ç–∞
# {"job_id": 1}

# –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
watch -n 10 'curl -s http://localhost:8084/migration/jobs/1 | jq'
```

–í—ã–≤–æ–¥:
```json
{
  "id": 1,
  "source_type": "excel",
  "status": "running",
  "total": 100000,
  "processed": 45000,
  "failed": 120,
  "progress": 45.0
}
```

## üéØ –ï—Å–ª–∏ —Ñ–∞–π–ª –û–ß–ï–ù–¨ –±–æ–ª—å—à–æ–π (>50 –ú–ë)

### –í–∞—Ä–∏–∞–Ω—Ç 1: –†–∞–∑–±–∏—Ç—å —Ñ–∞–π–ª

```bash
# –†–∞–∑–±–∏—Ç—å –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ 10,000 —Å—Ç—Ä–æ–∫
split -l 10000 large_file.csv part_

# –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —á–∞—Å—Ç—è–º
for file in part_*; do
    curl -X POST http://localhost:8084/migration/excel -F "file=@$file"
done
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Streaming –æ–±—Ä–∞–±–æ—Ç–∫–∞

–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–∞ streaming API excelize:

```go
// –í–º–µ—Å—Ç–æ GetRows() –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Rows()
rows, err := f.Rows(sheetName)
if err != nil {
    return err
}
defer rows.Close()

for rows.Next() {
    row, err := rows.Columns()
    if err != nil {
        continue
    }
    processRow(row)  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
- –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–∞–π–ª–∞–º–∏ –ª—é–±–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ù–µ –∑–Ω–∞–µ–º total –∑–∞—Ä–∞–Ω–µ–µ
- –ù–µ–ª—å–∑—è –ø–æ–∫–∞–∑–∞—Ç—å % –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

## üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª

```go
package main

import (
    "github.com/xuri/excelize/v2"
)

func main() {
    f := excelize.NewFile()
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    f.SetCellValue("Sheet1", "A1", "Phone")
    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 100,000 —Å—Ç—Ä–æ–∫
    for i := 2; i <= 100000; i++ {
        f.SetCellValue("Sheet1", fmt.Sprintf("A%d", i), "+79001234567")
        // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
    }
    
    f.SaveAs("test_large.xlsx")
}
```

### –ó–∞–º–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è

```bash
time curl -X POST http://localhost:8084/migration/excel \
  -F "file=@test_large.xlsx"
```

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è —Ñ–∞–π–ª–∞ 20 –ú–ë (~100,000 —Å—Ç—Ä–æ–∫):

1. **–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥—Ö–æ–¥–∏—Ç** ‚úÖ
2. –£–≤–µ–ª–∏—á–∏—Ç—å –ø–∞–º—è—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–æ 512 –ú–ë
3. –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –¥–æ 5 –º–∏–Ω—É—Ç
4. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —á–µ—Ä–µ–∑ API

### –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:

- **–ß—Ç–µ–Ω–∏–µ –∏ –ø–∞—Ä—Å–∏–Ω–≥:** 15-20 —Å–µ–∫
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö:** 1-2 –º–∏–Ω—É—Ç—ã
- **–ò–¢–û–ì–û:** 1.5-2.5 –º–∏–Ω—É—Ç—ã

### –ï—Å–ª–∏ —Ñ–∞–π–ª –±–æ–ª—å—à–µ 50 –ú–ë:

- –†–∞–∑–±–∏—Ç—å –Ω–∞ —á–∞—Å—Ç–∏
- –ò–ª–∏ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–∞ streaming API

**–í–∞—à —Ñ–∞–π–ª 20 –ú–ë –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –±–µ–∑ –ø—Ä–æ–±–ª–µ–º!** üöÄ
