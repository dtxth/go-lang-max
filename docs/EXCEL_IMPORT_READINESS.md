# –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å API –∫ –∏–º–ø–æ—Ä—Ç—É Excel

## ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –ù–ï –ì–û–¢–û–í–û (70%)

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è **–Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç** –≤–∞—à–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ Excel —Å 18 –∫–æ–ª–æ–Ω–∫–∞–º–∏.

## üóÇÔ∏è –ö—É–¥–∞ –ø–æ–ø–∞–¥—É—Ç –¥–∞–Ω–Ω—ã–µ

### 1. **Structure Service** ‚Üí PostgreSQL `structure_db`

| –¢–∞–±–ª–∏—Ü–∞ | –ü–æ–ª—è –∏–∑ Excel | –°—Ç–∞—Ç—É—Å |
|---------|---------------|--------|
| `universities` | –ö–æ–ª–æ–Ω–∫–∏ 4, 6, 7, 3 (Name, INN, KPP, FOIV) | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| `branches` | –ö–æ–ª–æ–Ω–∫–∞ 5 (–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–∞) | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| `faculties` | –ö–æ–ª–æ–Ω–∫–∞ 8 (–§–∞–∫—É–ª—å—Ç–µ—Ç/–∏–Ω—Å—Ç–∏—Ç—É—Ç) | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| `groups` | –ö–æ–ª–æ–Ω–∫–∏ 9, 10 (–ö—É—Ä—Å, –ù–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã) | ‚úÖ –ì–æ—Ç–æ–≤–æ |

### 2. **Chat Service** ‚Üí PostgreSQL `chat_db`

| –¢–∞–±–ª–∏—Ü–∞ | –ü–æ–ª—è –∏–∑ Excel | –°—Ç–∞—Ç—É—Å |
|---------|---------------|--------|
| `chats` | –ö–æ–ª–æ–Ω–∫–∏ 11, 15 (–ù–∞–∑–≤–∞–Ω–∏–µ, link) | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| `chats.external_chat_id` | –ö–æ–ª–æ–Ω–∫–∞ 14 (chat_id) | ‚ùå **–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å** |
| `administrators` | –ö–æ–ª–æ–Ω–∫–∏ 0/12, 1 (–¢–µ–ª–µ—Ñ–æ–Ω, max_id) | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| `administrators.add_user` | –ö–æ–ª–æ–Ω–∫–∞ 16 | ‚ùå **–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å** |
| `administrators.add_admin` | –ö–æ–ª–æ–Ω–∫–∞ 17 | ‚ùå **–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å** |

### 3. **Migration Service** ‚Üí PostgreSQL `migration_db`

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|---------|------------|--------|
| `migration_jobs` | –°—Ç–∞—Ç—É—Å –∏–º–ø–æ—Ä—Ç–∞, –ø—Ä–æ–≥—Ä–µ—Å—Å | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| `migration_errors` | –û—à–∏–±–∫–∏ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ | ‚úÖ –ì–æ—Ç–æ–≤–æ |

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

### 1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ –ë–î (5 –º–∏–Ω—É—Ç)

```sql
-- chat-service/migrations/002_add_missing_fields.sql
ALTER TABLE chats ADD COLUMN external_chat_id TEXT;
CREATE INDEX idx_chats_external_chat_id ON chats(external_chat_id);

ALTER TABLE administrators ADD COLUMN add_user BOOLEAN DEFAULT TRUE;
ALTER TABLE administrators ADD COLUMN add_admin BOOLEAN DEFAULT TRUE;
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å Go —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (10 –º–∏–Ω—É—Ç)

```go
// chat-service/internal/domain/chat.go
type Chat struct {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
    ExternalChatID *string `json:"external_chat_id,omitempty"` // –ö–æ–ª–æ–Ω–∫–∞ 14
}

// chat-service/internal/domain/administrator.go
type Administrator struct {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
    AddUser  bool `json:"add_user"`   // –ö–æ–ª–æ–Ω–∫–∞ 16
    AddAdmin bool `json:"add_admin"`  // –ö–æ–ª–æ–Ω–∫–∞ 17
}
```

### 3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ Excel (15 –º–∏–Ω—É—Ç)

–¢–µ–∫—É—â–∏–π –∫–æ–¥ –æ–∂–∏–¥–∞–µ—Ç **11 –∫–æ–ª–æ–Ω–æ–∫**, –∞ —É –≤–∞—Å **18 –∫–æ–ª–æ–Ω–æ–∫**!

–ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å:
- `ExcelRow` —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ `migration-service/internal/usecase/migrate_from_excel.go`
- –§—É–Ω–∫—Ü–∏—é `readFromExcel()` –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è 18 –∫–æ–ª–æ–Ω–æ–∫
- –§—É–Ω–∫—Ü–∏—é `processRow()` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π

## üìä –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ Excel ‚Üí –ë–î

| ‚Ññ | –ö–æ–ª–æ–Ω–∫–∞ Excel | –¢–∞–±–ª–∏—Ü–∞.–ü–æ–ª–µ | –°–µ—Ä–≤–∏—Å |
|---|---------------|--------------|--------|
| 0 | –¢–µ–ª–µ—Ñ–æ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ | `administrators.phone` | Chat |
| 1 | max_id | `administrators.max_id` | Chat |
| 2 | –ò–ù–ù_–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ | - (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) | - |
| 3 | –§–û–ò–í_–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ | `universities.foiv` | Structure |
| 4 | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ | `universities.name` | Structure |
| 5 | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–∞ | `branches.name` | Structure |
| 6 | –ò–ù–ù —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞ | `universities.inn` | Structure |
| 7 | –ö–ü–ü | `universities.kpp` | Structure |
| 8 | –§–∞–∫—É–ª—å—Ç–µ—Ç/–∏–Ω—Å—Ç–∏—Ç—É—Ç | `faculties.name` | Structure |
| 9 | –ö—É—Ä—Å –æ–±—É—á–µ–Ω–∏—è | `groups.course` | Structure |
| 10 | –ù–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã | `groups.number` | Structure |
| 11 | –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ | `chats.name` | Chat |
| 12 | –¢–µ–ª–µ—Ñ–æ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ | `administrators.phone` | Chat |
| 13 | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ | - (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) | - |
| 14 | chat_id | `chats.external_chat_id` ‚ùå | Chat |
| 15 | link | `chats.url` | Chat |
| 16 | add_user | `administrators.add_user` ‚ùå | Chat |
| 17 | add_admin | `administrators.add_admin` ‚ùå | Chat |

**–õ–µ–≥–µ–Ω–¥–∞:** ‚úÖ –ì–æ—Ç–æ–≤–æ | ‚ùå –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å

## üéØ –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–º–ø–æ—Ä—Ç–∞

–ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ **–æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏** –∏–∑ Excel –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ:

```
Structure Service DB:
‚îú‚îÄ universities: 1 –∑–∞–ø–∏—Å—å (–ú–ì–¢–£, –ò–ù–ù: 105014177, –ö–ü–ü: 10501001)
‚îú‚îÄ branches: 1 –∑–∞–ø–∏—Å—å (–§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ...)
‚îú‚îÄ faculties: 1 –∑–∞–ø–∏—Å—å (–ü–æ–ª–∏—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–æ–ª–ª–µ–¥–∂ –ú–ì–¢–£)
‚îî‚îÄ groups: 1 –∑–∞–ø–∏—Å—å (–ö—É—Ä—Å: 2, –ì—Ä—É–ø–ø–∞: –ö–æ–ª–ª–µ–¥–∂ –ò–ü-22 (2024)

Chat Service DB:
‚îú‚îÄ chats: 1 –∑–∞–ø–∏—Å—å
‚îÇ  ‚îú‚îÄ name: "–ö–æ–ª–ª–µ–¥–∂ –ò–ü-22 (2024 –û–§–û –ú–ì–¢–£"
‚îÇ  ‚îú‚îÄ url: "https://max.ru/join/..."
‚îÇ  ‚îú‚îÄ external_chat_id: "-69257108032233" ‚ùå
‚îÇ  ‚îî‚îÄ university_id: 1
‚îî‚îÄ administrators: 1 –∑–∞–ø–∏—Å—å
   ‚îú‚îÄ phone: "+79884753064"
   ‚îú‚îÄ max_id: "496728250"
   ‚îú‚îÄ add_user: true ‚ùå
   ‚îî‚îÄ add_admin: true ‚ùå
```

## ‚è±Ô∏è –í—Ä–µ–º—è –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É: 30 –º–∏–Ω—É—Ç

1. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (5 –º–∏–Ω)
2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Go —Å—Ç—Ä—É–∫—Ç—É—Ä (10 –º–∏–Ω)
3. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Excel –º–∞–ø–ø–∏–Ω–≥–∞ (15 –º–∏–Ω)

## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Å–ª–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

```bash
# 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
docker-compose exec -T chat-db psql -U chat_user -d chat_db < chat-service/migrations/002_add_missing_fields.sql

# 2. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã
docker-compose up -d --build migration-service chat-service

# 3. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å Excel
curl -X POST http://localhost:8084/migration/excel \
  -F "file=@–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —á–∞—Ç–æ–≤ –≥—Ä—É–ø–ø –ú–ì–¢–£ –≤ –ú–ê–• 17.11.25_–ò–¢–û–ì.xlsx"

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
curl http://localhost:8084/migration/jobs/1
```

## üìù –í—ã–≤–æ–¥

**API –Ω–∞ 70% –≥–æ—Ç–æ–≤–æ –∫ –∏–º–ø–æ—Ä—Ç—É**, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏:
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç 3 –ø–æ–ª—è –≤ –ë–î
- ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ Excel (–æ–∂–∏–¥–∞–µ—Ç 11, –∞ –Ω—É–∂–Ω–æ 18)
- ‚úÖ –í—Å—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –≥–æ—Ç–æ–≤–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å, –ø–æ—Ç–æ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å.
