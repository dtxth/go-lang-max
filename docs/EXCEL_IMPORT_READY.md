# ‚úÖ Excel Import Ready!

## üéâ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –∏–º–ø–æ—Ä—Ç—É Excel —Ñ–∞–π–ª–æ–≤ —Å 18 –∫–æ–ª–æ–Ω–∫–∞–º–∏.

## üìù –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞ –ë–î (chat-service)

**–§–∞–π–ª:** `chat-service/migrations/002_add_excel_fields.sql`

```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ external_chat_id –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è chat_id –∏–∑ Excel
ALTER TABLE chats ADD COLUMN external_chat_id TEXT;
CREATE INDEX idx_chats_external_chat_id ON chats(external_chat_id);

-- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ–ª–∞–≥–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
ALTER TABLE administrators ADD COLUMN add_user BOOLEAN DEFAULT TRUE;
ALTER TABLE administrators ADD COLUMN add_admin BOOLEAN DEFAULT TRUE;
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω—ã Go —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

**chat-service/internal/domain/chat.go:**
```go
type Chat struct {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
    ExternalChatID *string `json:"external_chat_id,omitempty"` // –ö–æ–ª–æ–Ω–∫–∞ 14
}
```

**chat-service/internal/domain/administrator.go:**
```go
type Administrator struct {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
    AddUser  bool `json:"add_user"`   // –ö–æ–ª–æ–Ω–∫–∞ 16
    AddAdmin bool `json:"add_admin"`  // –ö–æ–ª–æ–Ω–∫–∞ 17
}
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ Excel

**migration-service/internal/usecase/migrate_from_excel.go:**
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ 18 –∫–æ–ª–æ–Ω–æ–∫
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ external_chat_id (–∫–æ–ª–æ–Ω–∫–∞ 14)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ max_id (–∫–æ–ª–æ–Ω–∫–∞ 1)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–ª–∞–≥–æ–≤ add_user/add_admin (–∫–æ–ª–æ–Ω–∫–∏ 16-17)
- ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
- ‚úÖ –í—ã–±–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–æ–ª–æ–Ω–∫–∞ 0, –∑–∞—Ç–µ–º 12)

### 4. –û–±–Ω–æ–≤–ª–µ–Ω—ã API endpoints

**POST /chats** - —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `external_chat_id`
**POST /chats/{id}/administrators** - —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `max_id`, `add_user`, `add_admin`

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

```bash
./apply_excel_migration.sh
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
docker-compose exec -T chat-db psql -U chat_user -d chat_db < chat-service/migrations/002_add_excel_fields.sql
```

### –®–∞–≥ 2: –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã

```bash
docker-compose up -d --build chat-service migration-service
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å
docker-compose ps

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose logs -f migration-service
docker-compose logs -f chat-service
```

## üìä –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ Excel ‚Üí –ë–î

| ‚Ññ | –ö–æ–ª–æ–Ω–∫–∞ Excel | –¢–∞–±–ª–∏—Ü–∞.–ü–æ–ª–µ | –°–µ—Ä–≤–∏—Å | –°—Ç–∞—Ç—É—Å |
|---|---------------|--------------|--------|--------|
| 0 | –¢–µ–ª–µ—Ñ–æ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ | `administrators.phone` | Chat | ‚úÖ |
| 1 | max_id | `administrators.max_id` | Chat | ‚úÖ |
| 2 | –ò–ù–ù_–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ | - (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) | - | ‚ö†Ô∏è |
| 3 | –§–û–ò–í_–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ | `universities.foiv` | Structure | ‚úÖ |
| 4 | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ | `universities.name` | Structure | ‚úÖ |
| 5 | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–∞ | `branches.name` | Structure | ‚úÖ |
| 6 | –ò–ù–ù —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞ | `universities.inn` | Structure | ‚úÖ |
| 7 | –ö–ü–ü | `universities.kpp` | Structure | ‚úÖ |
| 8 | –§–∞–∫—É–ª—å—Ç–µ—Ç/–∏–Ω—Å—Ç–∏—Ç—É—Ç | `faculties.name` | Structure | ‚úÖ |
| 9 | –ö—É—Ä—Å –æ–±—É—á–µ–Ω–∏—è | `groups.course` | Structure | ‚úÖ |
| 10 | –ù–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã | `groups.number` | Structure | ‚úÖ |
| 11 | –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ | `chats.name` | Chat | ‚úÖ |
| 12 | –¢–µ–ª–µ—Ñ–æ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ | `administrators.phone` | Chat | ‚úÖ |
| 13 | –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ | - (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) | - | ‚ö†Ô∏è |
| 14 | chat_id | `chats.external_chat_id` | Chat | ‚úÖ |
| 15 | link | `chats.url` | Chat | ‚úÖ |
| 16 | add_user | `administrators.add_user` | Chat | ‚úÖ |
| 17 | add_admin | `administrators.add_admin` | Chat | ‚úÖ |

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: 100%** ‚úÖ

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ò–º–ø–æ—Ä—Ç Excel —Ñ–∞–π–ª–∞

```bash
curl -X POST http://localhost:8084/migration/excel \
  -F "file=@–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —á–∞—Ç–æ–≤ –≥—Ä—É–ø–ø –ú–ì–¢–£ –≤ –ú–ê–• 17.11.25_–ò–¢–û–ì.xlsx"
```

–û—Ç–≤–µ—Ç:
```json
{
  "job_id": 1,
  "status": "running"
}
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
curl http://localhost:8084/migration/jobs/1
```

–û—Ç–≤–µ—Ç:
```json
{
  "id": 1,
  "source_type": "excel",
  "status": "completed",
  "total": 100,
  "processed": 98,
  "failed": 2,
  "created_at": "2024-12-03T10:00:00Z",
  "updated_at": "2024-12-03T10:05:00Z"
}
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```bash
# –ü–æ–ª—É—á–∏—Ç—å —á–∞—Ç—ã
curl http://localhost:8082/chats

# –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Ç —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏
curl http://localhost:8082/chats/1
```

–û—Ç–≤–µ—Ç:
```json
{
  "id": 1,
  "name": "–ö–æ–ª–ª–µ–¥–∂ –ò–ü-22 (2024 –û–§–û –ú–ì–¢–£",
  "url": "https://max.ru/join/fqQlVkO6LU-RAw5HkshlQy6giI9kJiFU_a0OoJ75TTQ",
  "external_chat_id": "-69257108032233",
  "university_id": 1,
  "source": "academic_group",
  "administrators": [
    {
      "id": 1,
      "phone": "+79884753064",
      "max_id": "496728250",
      "add_user": true,
      "add_admin": true
    }
  ]
}
```

## üìã –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–º–ø–æ—Ä—Ç–∞

–ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ **–æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏** –∏–∑ Excel:

```
Structure Service DB (structure_db):
‚îú‚îÄ universities: 1 –∑–∞–ø–∏—Å—å
‚îÇ  ‚îú‚îÄ name: "–§–ï–î–ï–†–ê–õ–¨–ù–û–ï –ì–û–°–£–î–ê–†–°–¢–í–ï–ù–ù–û–ï –ë–Æ–î–ñ–ï–¢–ù–û–ï..."
‚îÇ  ‚îú‚îÄ inn: "105014177"
‚îÇ  ‚îú‚îÄ kpp: "10501001"
‚îÇ  ‚îî‚îÄ foiv: "–ú–∏–Ω–æ–±—Ä–Ω–∞—É–∫–∏ –†–æ—Å—Å–∏–∏"
‚îÇ
‚îú‚îÄ branches: 1 –∑–∞–ø–∏—Å—å
‚îÇ  ‚îî‚îÄ name: "–§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ –±—é–¥–∂–µ—Ç–Ω–æ–µ..."
‚îÇ
‚îú‚îÄ faculties: 1 –∑–∞–ø–∏—Å—å
‚îÇ  ‚îî‚îÄ name: "–ü–æ–ª–∏—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–æ–ª–ª–µ–¥–∂ –ú–ì–¢–£"
‚îÇ
‚îî‚îÄ groups: 1 –∑–∞–ø–∏—Å—å
   ‚îú‚îÄ course: 2
   ‚îú‚îÄ number: "–ö–æ–ª–ª–µ–¥–∂ –ò–ü-22 (2024"
   ‚îî‚îÄ chat_id: 1

Chat Service DB (chat_db):
‚îú‚îÄ chats: 1 –∑–∞–ø–∏—Å—å
‚îÇ  ‚îú‚îÄ name: "–ö–æ–ª–ª–µ–¥–∂ –ò–ü-22 (2024 –û–§–û –ú–ì–¢–£"
‚îÇ  ‚îú‚îÄ url: "https://max.ru/join/..."
‚îÇ  ‚îú‚îÄ external_chat_id: "-69257108032233" ‚úÖ
‚îÇ  ‚îú‚îÄ university_id: 1
‚îÇ  ‚îî‚îÄ source: "academic_group"
‚îÇ
‚îî‚îÄ administrators: 1 –∑–∞–ø–∏—Å—å
   ‚îú‚îÄ chat_id: 1
   ‚îú‚îÄ phone: "+79884753064"
   ‚îú‚îÄ max_id: "496728250" ‚úÖ
   ‚îú‚îÄ add_user: true ‚úÖ
   ‚îî‚îÄ add_admin: true ‚úÖ

Migration Service DB (migration_db):
‚îî‚îÄ migration_jobs: 1 –∑–∞–ø–∏—Å—å
   ‚îú‚îÄ source_type: "excel"
   ‚îú‚îÄ status: "completed"
   ‚îú‚îÄ total: 1
   ‚îú‚îÄ processed: 1
   ‚îî‚îÄ failed: 0
```

## üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤

–§—É–Ω–∫—Ü–∏—è `normalizePhone()` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
- `79884753064` ‚Üí `+79884753064`
- `89884753064` ‚Üí `+79884753064`
- `9884753064` ‚Üí `+79884753064`

### –í—ã–±–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. –ö–æ–ª–æ–Ω–∫–∞ 0 (–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
2. –ö–æ–ª–æ–Ω–∫–∞ 12 (–ú–æ–±–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞)

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–ª–∞–≥–æ–≤

–§–ª–∞–≥–∏ `add_user` –∏ `add_admin` —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç:
- `–ò–°–¢–ò–ù–ê` ‚Üí `true`
- `TRUE` ‚Üí `true`
- –õ—é–±–æ–µ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Üí `false`

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –ü—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è —Å—Ç—Ä–æ–∫–∏ —Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–æ–ª–æ–Ω–æ–∫ (< 18)
- –ü—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (INN, ChatURL)
- –û—à–∏–±–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `migration_errors` –Ω–æ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –ø—Ä–æ—Ü–µ—Å—Å
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `add_admin = –ò–°–¢–ò–ù–ê`

## üéØ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

- ‚úÖ –í—Å–µ –ø–æ–ª—è –∏–∑ Excel –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –≥–æ—Ç–æ–≤—ã
- ‚úÖ API endpoints –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏–º–ø–æ—Ä—Ç—É –≤–∞—à–∏—Ö Excel —Ñ–∞–π–ª–æ–≤!** üöÄ
