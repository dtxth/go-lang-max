# Реализация пагинации, сортировки и поиска для /chats/all

## Что было добавлено

### 1. Новые методы в репозитории
- `GetAllWithSortingAndSearch()` - получение чатов с сортировкой и поиском
- Расширенная фильтрация с поддержкой ролевого доступа

### 2. Новый метод в сервисе
- `GetAllChatsWithSortingAndSearch()` - бизнес-логика для работы с расширенными параметрами

### 3. Обновленный HTTP хендлер
- Поддержка новых query параметров: `sort_by`, `sort_order`, `search`
- Возврат структурированного ответа с метаданными пагинации
- Сохранение ролевой фильтрации

### 4. Новые структуры
- `PaginatedChatsResponse` - структура ответа с расширенной пагинацией
- `ChatServiceInterface` - интерфейс для сервиса чатов

## Поддерживаемые параметры

### Пагинация
- `limit` - количество записей (по умолчанию 50, максимум 100)
- `offset` - смещение от начала

### Сортировка
- `sort_by` - поле для сортировки (id, name, url, max_chat_id, participants_count, department, source, university, created_at, updated_at)
- `sort_order` - порядок сортировки (asc, desc)

### Поиск
- `search` - поисковый запрос по всем полям чата

## Поля для поиска
- Название чата
- Подразделение (department)
- Название университета
- MAX Chat ID
- Источник (source)

## Ролевая фильтрация
- **Суперадмин** - видит все чаты
- **Куратор** - видит только чаты своего университета
- **Оператор** - видит только чаты своего университета

## Формат ответа
```json
{
  "data": [...],
  "total": 150,
  "limit": 50,
  "offset": 0,
  "total_pages": 3
}
```

## Файлы изменены
1. `internal/domain/chat_repository.go` - добавлен новый метод в интерфейс
2. `internal/infrastructure/repository/chat_postgres.go` - реализация нового метода
3. `internal/usecase/chat_service.go` - новый метод сервиса
4. `internal/infrastructure/http/handler.go` - обновленный хендлер
5. `internal/domain/chat_service.go` - новый интерфейс сервиса

## Файлы созданы
1. `internal/infrastructure/http/handler_pagination_test.go` - тесты для новой функциональности
2. `PAGINATION_SORTING_SEARCH_API.md` - документация API
3. `USAGE_EXAMPLES.md` - примеры использования

## Тесты
Созданы тесты для проверки:
- Пагинации
- Поиска
- Сортировки
- Авторизации и ролевой фильтрации

## Обратная совместимость
Все изменения обратно совместимы. Старые запросы без новых параметров продолжают работать как раньше.

## Безопасность
- Сохранена ролевая фильтрация на уровне базы данных
- Требуется валидный JWT токен для доступа
- Автоматическая фильтрация по университету для кураторов и операторов

## Производительность
- Поиск использует ILIKE с оптимизацией для PostgreSQL
- Сортировка оптимизирована для индексированных полей
- Пагинация предотвращает загрузку больших объемов данных
- Ролевая фильтрация применяется на уровне SQL-запроса

## Особенности реализации
- Поддержка поиска по нескольким словам
- Нормализация поискового запроса (удаление специальных символов)
- Экранирование специальных символов LIKE
- Загрузка администраторов чатов одним batch-запросом для оптимизации